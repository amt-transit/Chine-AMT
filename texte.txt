const firebaseConfig = {
  apiKey: "AIzaSyA0_2U_6muRzphWlvKZN-lP6mytzaKIj1A",
  authDomain: "chine-amt.firebaseapp.com",
  projectId: "chine-amt",
  storageBucket: "chine-amt.firebasestorage.app",
  messagingSenderId: "864644062373",
  appId: "1:864644062373:web:a3066965408fdd9387c14c"
};


chine@gmail.com
123AmtChine@
abidjan@gmail.com
123AmtAbidjan!

<link rel="icon" type="image/png" href="logo_amt.png">

Je vais D'abord te montrer mes 3 fichiers ensuite je te dirais les modifications que je souhaite apporter.
index.html
<!DOCTYPE html>
<html lang="fr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>AMT Suivi de Fret</title>
Â  Â  <link rel="stylesheet" href="style.css">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
Â  Â  <link rel="icon" type="image/png" href="/logo_amt.png">
</head>
<body>

Â  Â  <div id="login-overlay">
Â  Â  Â  Â  <div class="login-box">
Â  Â  Â  Â  Â  Â  <img src="logo_amt.png" alt="Logo" class="login-logo">
Â  Â  Â  Â  Â  Â  <h2>Connexion AMT</h2>
Â  Â  Â  Â  Â  Â  <form id="login-form">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Email</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="login-email" placeholder="chine@amt.com" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Mot de passe</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="login-password" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-principal">Se connecter</button>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="login-error" class="text-red"></p>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="app-container" style="display:none;">
Â  Â  Â  Â  
Â  Â  Â  Â  <header>
Â  Â  Â  Â  Â  Â  <div class="logo-container">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="logo_amt.png" alt="Logo AMT Transit" class="logo">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="header-info">
Â  Â  Â  Â  Â  Â  Â  Â  <span>Agence: <span id="agence-nom">Chine</span></span>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deconnexion()" class="btn-secondaire btn-small" style="margin-left:10px; background-color: #dc3545; color: white;">DÃ©connexion</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <nav class="main-nav">
Â  Â  Â  Â  Â  Â  <button class="nav-link" id="nav-envoi" onclick="ouvrirPage(event, 'Envoi')">ğŸ“¦ Envoi (Chine)</button>
Â  Â  Â  Â  Â  Â  <button class="nav-link" id="nav-historique" onclick="ouvrirPage(event, 'Historique')">ğŸ“ Historique & Modif</button>
Â  Â  Â  Â  Â  Â  <button class="nav-link" id="nav-reception" onclick="ouvrirPage(event, 'Reception')">ğŸ“¥ RÃ©ception (Abidjan)</button>
Â  Â  Â  Â  Â  Â  <button class="nav-link" id="nav-compta" onclick="ouvrirPage(event, 'Comptabilite')">ğŸ’° ComptabilitÃ©</button>
Â  Â  Â  Â  </nav>

Â  Â  Â  Â  <main>
Â  Â  Â  Â  Â  Â  <section id="Envoi" class="page-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Enregistrer un envoi groupÃ©</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="form-envoi-commun" class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>1. Informations communes</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Date d'envoi</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="date-envoi" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Type d'envoi</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="type-envoi" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Choisir --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aerien_normal">AÃ©rien Normal (10 000/Kg)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aerien_express">AÃ©rien Express (12 000/Kg)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="maritime">Maritime (250 000/CBM)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="info-text">RÃ©fÃ©rence groupe auto-gÃ©nÃ©rÃ©e (ex: EV10).</p>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <form id="form-ajout-client" class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>2. Ajouter un client</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ExpÃ©diteur</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="expediteur-nom" value="AMT TRANSIT CARGO">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>NumÃ©ro ExpÃ©diteur</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="expediteur-tel" value="+225 0703165050">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group autocomplete-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nom</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="client-nom" required autocomplete="off">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="autocomplete-suggestions" class="autocomplete-items"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>PrÃ©nom</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="client-prenom" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>TÃ©lÃ©phone</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="client-tel" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Description</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="client-desc" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>QuantitÃ© (colis)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="quantite-envoyee" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" id="champ-poids">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Poids (Kg)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="poids-envoye" step="0.01" min="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" id="champ-volume">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Volume (CBM)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="volume-envoye" step="0.001" min="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Photos</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="photos-colis" accept="image/*" multiple>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="apercu-photos"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Prix estimÃ© : <span id="prix-calcule">0 CFA</span></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="btn-ajouter-client" class="btn-secondaire">Ajouter Ã  la liste</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>3. Liste d'attente</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="table-envoi-en-cours">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Nom</th><th>Desc.</th><th>QtÃ©</th><th>Poids/Vol</th><th>Prix</th><th>Action</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tbody-envoi-en-cours"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="btn-valider-envoi-groupe" class="btn-principal">Valider l'envoi</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="Historique" class="page-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Historique & Modification (Chine)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub-nav-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-nav-link active" id="btn-hist-maritime" onclick="ouvrirSousOngletHistorique('maritime')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-ship"></i> Maritime
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-nav-link" id="btn-hist-aerien" onclick="ouvrirSousOngletHistorique('aerien')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-plane"></i> AÃ©rien
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="search-hist-chine" placeholder="Rechercher par Nom ou Ref...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="excel-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Ref</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Client</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>QtÃ© Env.</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Poids/Vol Env.</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Prix Final</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Info Modif</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tbody-historique-chine"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="Reception" class="page-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>RÃ©ception (Abidjan)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub-nav-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-nav-link active" id="btn-rec-maritime" onclick="ouvrirSousOngletReception('maritime')"><i class="fas fa-ship"></i> Maritime</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-nav-link" id="btn-rec-aerien" onclick="ouvrirSousOngletReception('aerien')"><i class="fas fa-plane"></i> AÃ©rien</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><input type="text" id="search-input" placeholder="Rechercher..."></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="export-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-export-pdf" class="btn-secondaire">PDF</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-export-excel" class="btn-secondaire">Excel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="table-expeditions" class="interactive-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Ref</th><th>Date</th><th>Client</th><th>Desc.</th><th>Type</th><th>QtÃ©</th><th>Poids/Vol</th><th>Prix Est.</th><th>Statut</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="liste-clients-tbody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="Comptabilite" class="page-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub-nav-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-nav-link active" onclick="ouvrirSousOngletCompta('maritime')"><i class="fas fa-ship"></i> Maritime</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-nav-link" onclick="ouvrirSousOngletCompta('aerien')"><i class="fas fa-plane"></i> AÃ©rien</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card compta-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="compta-header"><h2 id="titre-compta">SUIVI FINANCIER</h2></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dashboard-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dashboard-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-row red-bg"><span>CrÃ©dit</span><span id="total-credit">0 CFA</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-row white-bg"><span>Solde Caisse</span><span id="total-caisse">0 CFA</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-row blue-light-bg"><span>Bonus</span><span id="total-bonus">0 CFA</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dashboard-payments-modern">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="modern-payment-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Type</th><th>EntrÃ©e</th><th>Sortie</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>EspÃ¨ce</td><td id="pay-espece-in">0</td><td id="pay-espece-out">0</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>ChÃ¨que</td><td id="pay-cheque-in">0</td><td id="pay-cheque-out">0</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>Orange Money</td><td id="pay-om-in">0</td><td id="pay-om-out">0</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>Wave</td><td id="pay-wave-in">0</td><td id="pay-wave-out">0</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>CB</td><td id="pay-cb-in">0</td><td id="pay-cb-out">0</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="modern-total-row"><td>TOTAL</td><td id="pay-total-in">0</td><td id="pay-total-out">0</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container mt-20">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondaire btn-small" onclick="ouvrirModalDepense()">+ DÃ©pense</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="table-compta-details" class="excel-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Date</th><th>Ref</th><th>Desc</th><th>Client</th><th>DÃ»</th><th>Reste</th><th>EntrÃ©e</th><th>Sortie</th><th>Action</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tbody-compta"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  </main>
Â  Â  </div> 

Â  Â  <div id="modal-backdrop" class="modal-backdrop" onclick="fermerModal(event)">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="modal-close" onclick="fermerModal(event)">&times;</span>
Â  Â  Â  Â  Â  Â  <div id="details-reception">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>DÃ©tails : <span id="client-selectionne"></span></h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ExpÃ©diteur: <strong><span id="expediteur-affiche"></span></strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ref: <strong><span id="ref-attendue"></span></strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Desc: <span id="desc-attendue"></span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  TÃ©l: <span id="tel-attendu"></span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Attendu: <span id="qte-attendue"></span> | <span id="poids-attendu"></span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Prix Initial: <span id="prix-attendu"></span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong style="font-size:1.2em; color:#dc3545;">Reste: <span id="prix-restant"></span></strong>
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" id="photos-recues-container" style="display:none;"><div id="photos-recues-apercu"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondaire" onclick="genererEtiquette()" style="background-color: #f39c12; color: white;">Ã‰tiquette</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondaire" onclick="genererFacture()" style="background-color: #34495e; color: white;">Facture</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="reception-status-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="reception-status" class="status-badge"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="reception-summary"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="reception-differences-display"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="form-reception-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Ajouter RÃ©ception :</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="form-reception">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>QuantitÃ©</label><input type="number" id="quantite-recue" min="0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label id="label-poids-recu">Poids/Vol</label><input type="number" id="poids-recu" step="0.01"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>PayÃ© (Tranche)</label><input type="number" id="montant-paye" min="0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Moyen</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="moyen-paiement">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="EspÃ¨ce">EspÃ¨ce</option><option value="ChÃ¨que">ChÃ¨que</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="OM">OM</option><option value="Wave">Wave</option><option value="CB">CB</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-principal" onclick="enregistrerReception()">Valider</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="modal-modif-chine" class="modal-backdrop" onclick="fermerModalModif(event)">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="modal-close" onclick="fermerModalModif(event)">&times;</span>
Â  Â  Â  Â  Â  Â  <h3>Modification : <span id="modif-client-titre"></span></h3>
Â  Â  Â  Â  Â  Â  <p>
Â  Â  Â  Â  Â  Â  Â  Â  Ref: <strong><span id="modif-ref-titre"></span></strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Desc: <span id="modif-desc-titre"></span>
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  <p class="info-text">Attention : Toute modification impactera le prix.</p>
Â  Â  Â  Â  Â  Â  <form id="form-modif-chine">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>QuantitÃ©</label><input type="number" id="modif-qte"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Poids / Volume</label><input type="number" id="modif-poids" step="0.01"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>RÃ©duction (CFA)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="modif-remise" placeholder="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>DÃ©duit du prix total.</small>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Prix Final CalculÃ©</label><input type="text" id="modif-prix-final" readonly></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-principal" onclick="sauvegarderModificationChine()">Enregistrer Modifications</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="modal-historique" class="modal-backdrop" onclick="fermerModalHistorique(event)">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="modal-close" onclick="fermerModalHistorique(event)">&times;</span>
Â  Â  Â  Â  Â  Â  <h3>Historique Transactions</h3>
Â  Â  Â  Â  Â  Â  <p><strong id="hist-client-nom"></strong> | <span id="hist-ref"></span></p>
Â  Â  Â  Â  Â  Â  <table class="modern-payment-table"><thead><tr><th>Date</th><th>Montant</th><th>Type</th></tr></thead><tbody id="tbody-historique"></tbody></table>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="modal-depense" class="modal-backdrop" onclick="fermerModalDepense(event)">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="modal-close" onclick="fermerModalDepense(event)">&times;</span>
Â  Â  Â  Â  Â  Â  <h3>Ajouter Sortie</h3>
Â  Â  Â  Â  Â  Â  <form id="form-depense">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Date</label><input type="date" id="depense-date" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Type</label><select id="depense-type"><option value="maritime">Maritime</option><option value="aerien">AÃ©rien</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Lier au Groupe</label><input type="text" id="depense-groupe" placeholder="ex: EV1"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Motif</label><input type="text" id="depense-motif" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Montant</label><input type="number" id="depense-montant" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label>Moyen</label><select id="depense-moyen"><option value="EspÃ¨ce">EspÃ¨ce</option><option value="ChÃ¨que">ChÃ¨que</option><option value="OM">OM</option><option value="Wave">Wave</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-principal btn-supprimer" onclick="enregistrerDepense()">Valider Sortie</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
Â  Â  <script src="script.js"></script>
</body>
</html>
script.js
// =======================================================
// 1. CONFIGURATION FIREBASE
// =======================================================
const firebaseConfig = {
Â  apiKey: "AIzaSyA0_2U_6muRzphWlvKZN-lP6mytzaKIj1A",
Â  authDomain: "chine-amt.firebaseapp.com",
Â  projectId: "chine-amt",
Â  storageBucket: "chine-amt.firebasestorage.app",
Â  messagingSenderId: "864644062373",
Â  appId: "1:864644062373:web:a3066965408fdd9387c14c"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();

// =======================================================
// 2. VARIABLES GLOBALES
// =======================================================
let envoiEnCours = [];
let clientsCharges = [];
let allPastClients = [];
let currentUser = null;
let currentRole = null;

const PRIX_AERIEN_NORMAL = 10000;
const PRIX_AERIEN_EXPRESS = 12000;
const PRIX_MARITIME_CBM = 250000;

let currentReceptionType = 'maritime';
let currentHistoriqueType = 'maritime';
let currentComptaType = 'maritime';
let currentEnvoi = null;
let currentModifEnvoi = null;

function formatArgent(montant) {
Â  Â  if (isNaN(montant)) return "0";
Â  Â  return parseInt(montant).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

// =======================================================
// 3. NAVIGATION ET AUTH
// =======================================================
function ouvrirPage(event, nomPage) {
Â  Â  const contents = document.getElementsByClassName("page-content");
Â  Â  for (let i = 0; i < contents.length; i++) {
Â  Â  Â  Â  if(contents[i]) contents[i].style.display = "none";
Â  Â  }
Â  Â  
Â  Â  const links = document.getElementsByClassName("nav-link");
Â  Â  for (let i = 0; i < links.length; i++) {
Â  Â  Â  Â  if(links[i]) links[i].className = links[i].className.replace(" active", "");
Â  Â  }
Â  Â  
Â  Â  const page = document.getElementById(nomPage);
Â  Â  if (page) page.style.display = "block";
Â  Â  
Â  Â  if (event && event.currentTarget) event.currentTarget.className += " active";
Â  Â  
Â  Â  // Changement de titre sÃ©curisÃ©
Â  Â  const agenceEl = document.getElementById('agence-nom');
Â  Â  if (agenceEl) {
Â  Â  Â  Â  if (nomPage === 'Envoi') {
Â  Â  Â  Â  Â  Â  agenceEl.innerText = 'Chine';
Â  Â  Â  Â  Â  Â  loadAllClientsForAutocomplete();
Â  Â  Â  Â  } else if (nomPage === 'Historique') {
Â  Â  Â  Â  Â  Â  agenceEl.innerText = 'Chine - Historique';
Â  Â  Â  Â  Â  Â  ouvrirSousOngletHistorique('maritime');
Â  Â  Â  Â  } else if (nomPage === 'Reception') {
Â  Â  Â  Â  Â  Â  agenceEl.innerText = 'Abidjan';
Â  Â  Â  Â  Â  Â  ouvrirSousOngletReception('maritime');
Â  Â  Â  Â  } else if (nomPage === 'Comptabilite') {
Â  Â  Â  Â  Â  Â  agenceEl.innerText = 'Abidjan - Compta';
Â  Â  Â  Â  Â  Â  ouvrirSousOngletCompta('maritime');
Â  Â  Â  Â  }
Â  Â  }
}

const loginForm = document.getElementById('login-form');
if (loginForm) {
Â  Â  loginForm.addEventListener('submit', (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const email = document.getElementById('login-email').value;
Â  Â  Â  Â  const pass = document.getElementById('login-password').value;
Â  Â  Â  Â  auth.signInWithEmailAndPassword(email, pass).catch(err => {
Â  Â  Â  Â  Â  Â  const errEl = document.getElementById('login-error');
Â  Â  Â  Â  Â  Â  if(errEl) errEl.innerText = "Erreur: " + err.message;
Â  Â  Â  Â  });
Â  Â  });
}

auth.onAuthStateChanged(user => {
Â  Â  const overlay = document.getElementById('login-overlay');
Â  Â  const app = document.getElementById('app-container');
Â  Â  const userDisplay = document.getElementById('user-display');

Â  Â  if (user) {
Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  if(overlay) overlay.style.display = 'none';
Â  Â  Â  Â  if(app) app.style.display = 'block';
Â  Â  Â  Â  
Â  Â  Â  Â  if (user.email.includes('chine')) {
Â  Â  Â  Â  Â  Â  currentRole = 'chine';
Â  Â  Â  Â  Â  Â  if(userDisplay) userDisplay.innerText = "Agence Chine";
Â  Â  Â  Â  Â  Â  const nR = document.getElementById('nav-reception'); if(nR) nR.style.display = 'none';
Â  Â  Â  Â  Â  Â  const nC = document.getElementById('nav-compta'); if(nC) nC.style.display = 'none';
Â  Â  Â  Â  Â  Â  ouvrirPage(null, 'Envoi');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  currentRole = 'abidjan';
Â  Â  Â  Â  Â  Â  if(userDisplay) userDisplay.innerText = "Agence Abidjan";
Â  Â  Â  Â  Â  Â  const nR = document.getElementById('nav-reception'); if(nR) nR.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  const nC = document.getElementById('nav-compta'); if(nC) nC.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  ouvrirPage(null, 'Reception');
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  if(overlay) overlay.style.display = 'flex';
Â  Â  Â  Â  if(app) app.style.display = 'none';
Â  Â  }
});

function deconnexion() { auth.signOut().then(() => window.location.reload()); }

// =======================================================
// FONCTIONS D'EXPORT (Ã€ PLACER AVANT LE DOMContentLoaded)
// =======================================================
function exporterExcel() {
Â  Â  if (clientsCharges.length === 0) { alert("Rien Ã  exporter."); return; }
Â  Â  // Ajout de "TÃ©lÃ©phone" dans l'en-tÃªte
Â  Â  let csvContent = "data:text/csv;charset=utf-8,Ref,Date,Client,TÃ©lÃ©phone,Desc,Type,QtÃ©,Poids,Prix,Statut\r\n";
Â  Â  
Â  Â  clientsCharges.forEach(c => {
Â  Â  Â  Â  // Ajout de c.tel ici
Â  Â  Â  Â  csvContent += `"${c.reference}","${c.date}","${c.nom}","${c.tel || ''}","${c.description}","${c.type}",${c.quantiteEnvoyee},"${c.poidsEnvoye||c.volumeEnvoye}","${c.prixEstime}","${c.status}"\r\n`;
Â  Â  });
Â  Â  
Â  Â  var link = document.createElement("a"); 
Â  Â  link.setAttribute("href", encodeURI(csvContent)); 
Â  Â  link.setAttribute("download", "expeditions.csv"); 
Â  Â  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

function exporterPDF() {
Â  Â  if (clientsCharges.length === 0) { alert("Rien Ã  exporter."); return; }
Â  Â  const { jsPDF } = window.jspdf; 
Â  Â  const doc = new jsPDF('l', 'mm', 'a4');
Â  Â  
Â  Â  // Ajout de "TÃ©l" dans les headers
Â  Â  const headers = [["Ref", "Date", "Client", "TÃ©l", "Desc", "Type", "QtÃ©", "Poids", "Prix", "Statut"]];
Â  Â  
Â  Â  const body = clientsCharges.map(c => [
Â  Â  Â  Â  c.reference, 
Â  Â  Â  Â  c.date, 
Â  Â  Â  Â  c.nom, 
Â  Â  Â  Â  c.tel || '', // Ajout du tÃ©lÃ©phone ici
Â  Â  Â  Â  c.description, 
Â  Â  Â  Â  c.type, 
Â  Â  Â  Â  c.quantiteEnvoyee, 
Â  Â  Â  Â  c.poidsEnvoye||c.volumeEnvoye, 
Â  Â  Â  Â  formatArgent(c.prixEstime.replace(/\D/g,'')), 
Â  Â  Â  Â  c.status
Â  Â  ]);
Â  Â  
Â  Â  doc.autoTable({ head: headers, body: body, styles: { fontSize: 7 } }); 
Â  Â  doc.save('expeditions.pdf');
}


// =======================================================
// 4. INITIALISATION (DOM READY)
// =======================================================
document.addEventListener('DOMContentLoaded', function() {
Â  Â  setTimeout(() => {
Â  Â  Â  Â  const activeLink = document.querySelector('.nav-link.active');
Â  Â  Â  Â  if (activeLink) activeLink.click();
Â  Â  }, 10);
Â  Â  loadAllClientsForAutocomplete();

Â  Â  // --- PAGE ENVOI ---
Â  Â  const typeEnvoiSelect = document.getElementById('type-envoi');
Â  Â  const poidsInput = document.getElementById('poids-envoye');
Â  Â  const volumeInput = document.getElementById('volume-envoye');
Â  Â  const photosInput = document.getElementById('photos-colis');
Â  Â  const btnAjouterClient = document.getElementById('btn-ajouter-client');
Â  Â  const btnValiderEnvoiGroupe = document.getElementById('btn-valider-envoi-groupe');

Â  Â  if(typeEnvoiSelect) {
Â  Â  Â  Â  typeEnvoiSelect.addEventListener('change', gererChampsEnvoi);
Â  Â  Â  Â  if(poidsInput) poidsInput.addEventListener('input', calculerPrixClient);
Â  Â  Â  Â  if(volumeInput) volumeInput.addEventListener('input', calculerPrixClient);
Â  Â  Â  Â  gererChampsEnvoi();
Â  Â  }

Â  Â  if(photosInput) {
Â  Â  Â  Â  photosInput.addEventListener('change', function() {
Â  Â  Â  Â  Â  Â  const apercuDiv = document.getElementById('apercu-photos');
Â  Â  Â  Â  Â  Â  if(apercuDiv) apercuDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (this.files.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Array.from(this.files).forEach(file => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (file.type.startsWith('image/')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = document.createElement('img'); img.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(apercuDiv) apercuDiv.appendChild(img);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if(btnAjouterClient) btnAjouterClient.addEventListener('click', ajouterClientALaListe);
Â  Â  if(btnValiderEnvoiGroupe) btnValiderEnvoiGroupe.addEventListener('click', validerEnvoiGroupe);

Â  Â  // Recherche & Export
Â  Â  const searchInput = document.getElementById('search-input');
Â  Â  if(searchInput) {
Â  Â  Â  Â  searchInput.addEventListener('input', function() {
Â  Â  Â  Â  Â  Â  const query = this.value.toLowerCase();
Â  Â  Â  Â  Â  Â  const rows = document.getElementById('liste-clients-tbody').getElementsByTagName('tr');
Â  Â  Â  Â  Â  Â  for(let row of rows) {
Â  Â  Â  Â  Â  Â  Â  Â  if(row.cells.length < 2) continue;
Â  Â  Â  Â  Â  Â  Â  Â  const txt = row.innerText.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  row.style.display = txt.includes(query) ? "" : "none";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â  const btnExpPDF = document.getElementById('btn-export-pdf');
Â  Â  const btnExpExcel = document.getElementById('btn-export-excel');
Â  Â  if(btnExpPDF) btnExpPDF.addEventListener('click', exporterPDF);
Â  Â  if(btnExpExcel) btnExpExcel.addEventListener('click', exporterExcel);

Â  Â  // Autocomplete
Â  Â  const nomInput = document.getElementById('client-nom');
Â  Â  if(nomInput) {
Â  Â  Â  Â  nomInput.addEventListener('input', function() {
Â  Â  Â  Â  Â  Â  const query = this.value.toLowerCase();
Â  Â  Â  Â  Â  Â  const box = document.getElementById('autocomplete-suggestions');
Â  Â  Â  Â  Â  Â  if (query.length < 1) { if(box) box.style.display = 'none'; return; }
Â  Â  Â  Â  Â  Â  const matches = allPastClients.filter(c => c.nom.toLowerCase().startsWith(query));
Â  Â  Â  Â  Â  Â  showSuggestions(matches);
Â  Â  Â  Â  });
Â  Â  Â  Â  document.addEventListener('click', e => {
Â  Â  Â  Â  Â  Â  if(!e.target.closest('.autocomplete-container')) {
Â  Â  Â  Â  Â  Â  Â  Â  const box = document.getElementById('autocomplete-suggestions');
Â  Â  Â  Â  Â  Â  Â  Â  if(box) box.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // Modifs dynamiques
Â  Â  const modifP = document.getElementById('modif-poids');
Â  Â  const modifR = document.getElementById('modif-remise');
Â  Â  if(modifP) modifP.oninput = calculerPrixModif;
Â  Â  if(modifR) modifR.oninput = calculerPrixModif;
});

// --- FONCTIONS ENVOI ---
function gererChampsEnvoi() {
Â  Â  const type = document.getElementById('type-envoi').value;
Â  Â  const p = document.getElementById('champ-poids');
Â  Â  const v = document.getElementById('champ-volume');
Â  Â  const vi = document.getElementById('volume-envoye');
Â  Â  const pi = document.getElementById('poids-envoye');
Â  Â  
Â  Â  if (type.startsWith('aerien')) {
Â  Â  Â  Â  p.style.display='block'; v.style.display='none'; if(vi) vi.value=0;
Â  Â  } else if (type==='maritime') {
Â  Â  Â  Â  p.style.display='none'; v.style.display='block'; if(pi) pi.value=0;
Â  Â  } else {
Â  Â  Â  Â  p.style.display='none'; v.style.display='none';
Â  Â  }
Â  Â  calculerPrixClient();
}

function calculerPrixClient() {
Â  Â  const type = document.getElementById('type-envoi').value;
Â  Â  const p = parseFloat(document.getElementById('poids-envoye').value)||0;
Â  Â  const v = parseFloat(document.getElementById('volume-envoye').value)||0;
Â  Â  let prix = 0;
Â  Â  if(type==='aerien_normal') prix = p * PRIX_AERIEN_NORMAL;
Â  Â  else if(type==='aerien_express') prix = p * PRIX_AERIEN_EXPRESS;
Â  Â  else if(type==='maritime') prix = v * PRIX_MARITIME_CBM;
Â  Â  
Â  Â  const el = document.getElementById('prix-calcule');
Â  Â  if(el) el.innerText = formatArgent(prix) + ' CFA';
}

function ajouterClientALaListe() {
Â  Â  const t = document.getElementById('type-envoi').value;
Â  Â  const d = document.getElementById('date-envoi').value;
Â  Â  if(!t||!d) { alert("Date et Type requis."); return; }
Â  Â  const n = document.getElementById('client-nom').value;
Â  Â  if(!n) { alert("Nom requis."); return; }
Â  Â  
Â  Â  const expN = document.getElementById('expediteur-nom').value || "AMT TRANSIT CARGO";
Â  Â  const expT = document.getElementById('expediteur-tel').value || "+225 0703165050";

Â  Â  const c = {
Â  Â  Â  Â  expediteur: expN, telExpediteur: expT,
Â  Â  Â  Â  nom: n,
Â  Â  Â  Â  prenom: document.getElementById('client-prenom').value,
Â  Â  Â  Â  tel: document.getElementById('client-tel').value,
Â  Â  Â  Â  description: document.getElementById('client-desc').value,
Â  Â  Â  Â  quantiteEnvoyee: document.getElementById('quantite-envoyee').value,
Â  Â  Â  Â  poidsEnvoye: parseFloat(document.getElementById('poids-envoye').value)||0,
Â  Â  Â  Â  volumeEnvoye: parseFloat(document.getElementById('volume-envoye').value)||0,
Â  Â  Â  Â  prixEstime: document.getElementById('prix-calcule').innerText,
Â  Â  Â  Â  photosFiles: Array.from(document.getElementById('photos-colis').files)
Â  Â  };
Â  Â  envoiEnCours.push(c);
Â  Â  mettreAJourTableauEnvoiEnCours();
Â  Â  document.getElementById('form-ajout-client').reset();
Â  Â  
Â  Â  // Remettre valeurs par dÃ©faut
Â  Â  document.getElementById('expediteur-nom').value = "AMT TRANSIT CARGO";
Â  Â  document.getElementById('expediteur-tel').value = "+225 0703165050";
Â  Â  
Â  Â  const ap = document.getElementById('apercu-photos');
Â  Â  if(ap) ap.innerHTML='';
Â  Â  calculerPrixClient();
}

function mettreAJourTableauEnvoiEnCours() {
Â  Â  const tbody = document.getElementById('tbody-envoi-en-cours');
Â  Â  if(!tbody) return;
Â  Â  tbody.innerHTML = '';
Â  Â  envoiEnCours.forEach((c, i) => {
Â  Â  Â  Â  let pv = document.getElementById('type-envoi').value.startsWith('aerien') ? c.poidsEnvoye : c.volumeEnvoye;
Â  Â  Â  Â  tbody.innerHTML += `<tr><td>${c.expediteur}</td><td>${c.nom}</td><td>${c.quantiteEnvoyee}</td><td>${pv}</td><td>${c.prixEstime}</td><td><button class="btn-action btn-supprimer" onclick="envoiEnCours.splice(${i},1);mettreAJourTableauEnvoiEnCours()">X</button></td></tr>`;
Â  Â  });
}

async function validerEnvoiGroupe() {
Â  Â  if(envoiEnCours.length===0) return;
Â  Â  const btn = document.getElementById('btn-valider-envoi-groupe');
Â  Â  btn.disabled=true; btn.innerText='En cours...';
Â  Â  try {
Â  Â  Â  Â  const d = document.getElementById('date-envoi').value;
Â  Â  Â  Â  const t = document.getElementById('type-envoi').value;
Â  Â  Â  Â  const refG = await genererRefGroupe(t);
Â  Â  Â  Â  const pref = t.startsWith('aerien') ? 'AIR' : 'MRT';

Â  Â  Â  Â  for(let i=0; i<envoiEnCours.length; i++) {
Â  Â  Â  Â  Â  Â  const c = envoiEnCours[i];
Â  Â  Â  Â  Â  Â  const idx = String(i+1).padStart(3,'0');
Â  Â  Â  Â  Â  Â  const ref = `${pref}-${idx}-${refG}`;
Â  Â  Â  Â  Â  Â  let photosURLs = [];
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  await db.collection('expeditions').add({
Â  Â  Â  Â  Â  Â  Â  Â  reference: ref, refGroupe: refG, date: d, type: t,
Â  Â  Â  Â  Â  Â  Â  Â  nom: c.nom, prenom: c.prenom, tel: c.tel, description: c.description,
Â  Â  Â  Â  Â  Â  Â  Â  expediteur: c.expediteur, telExpediteur: c.telExpediteur,
Â  Â  Â  Â  Â  Â  Â  Â  quantiteEnvoyee: parseInt(c.quantiteEnvoyee)||0,
Â  Â  Â  Â  Â  Â  Â  Â  poidsEnvoye: c.poidsEnvoye, volumeEnvoye: c.volumeEnvoye,
Â  Â  Â  Â  Â  Â  Â  Â  prixEstime: c.prixEstime, remise: 0,
Â  Â  Â  Â  Â  Â  Â  Â  creeLe: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  status: 'En attente', quantiteRecue: 0, poidsRecu: 0, montantPaye: 0, historiquePaiements: [], photosURLs: photosURLs
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  alert('Groupe '+refG+' enregistrÃ© !');
Â  Â  Â  Â  envoiEnCours = []; mettreAJourTableauEnvoiEnCours();
Â  Â  Â  Â  document.getElementById('form-envoi-commun').reset();
Â  Â  Â  Â  loadAllClientsForAutocomplete();
Â  Â  } catch(e) { alert(e.message); }
Â  Â  finally { btn.disabled=false; btn.innerText='Valider'; }
}

async function genererRefGroupe(t) {
Â  Â  const s = await db.collection('expeditions').orderBy('creeLe', 'desc').limit(50).get();
Â  Â  let max=0; s.forEach(d=>{ let g=d.data().refGroupe||""; if(g.startsWith('EV')){ let n=parseInt(g.replace('EV','')); if(n>max) max=n; } });
Â  Â  return 'EV'+(max+1);
}

async function loadAllClientsForAutocomplete() {
Â  Â  try {
Â  Â  Â  Â  const s = await db.collection('expeditions').get();
Â  Â  Â  Â  const m = new Map();
Â  Â  Â  Â  s.forEach(d => { const da=d.data(); if(da.tel) m.set(da.tel, {nom:da.nom, prenom:da.prenom, tel:da.tel}); });
Â  Â  Â  Â  allPastClients = Array.from(m.values());
Â  Â  } catch(e) {}
}

function showSuggestions(matches) {
Â  Â  const box = document.getElementById('autocomplete-suggestions');
Â  Â  if(box) box.innerHTML = '';
Â  Â  if (matches.length === 0) { if(box) box.style.display = 'none'; return; }
Â  Â  matches.slice(0, 5).forEach(c => {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.innerHTML = `<strong>${c.nom}</strong> ${c.prenom}`;
Â  Â  Â  Â  div.onclick = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('client-nom').value = c.nom;
Â  Â  Â  Â  Â  Â  document.getElementById('client-prenom').value = c.prenom||'';
Â  Â  Â  Â  Â  Â  document.getElementById('client-tel').value = c.tel||'';
Â  Â  Â  Â  Â  Â  box.style.display = 'none';
Â  Â  Â  Â  };
Â  Â  Â  Â  box.appendChild(div);
Â  Â  });
Â  Â  if(box) box.style.display = 'block';
}

// =======================================================
// 5. HISTORIQUE (SOUS-ONGLETS)
// =======================================================
function ouvrirSousOngletHistorique(type) {
Â  Â  currentHistoriqueType = type;
Â  Â  const b1 = document.getElementById('btn-hist-maritime');
Â  Â  const b2 = document.getElementById('btn-hist-aerien');
Â  Â  if(b1&&b2) { 
Â  Â  Â  Â  if(type==='maritime'){b1.classList.add('active');b2.classList.remove('active');} 
Â  Â  Â  Â  else {b1.classList.remove('active');b2.classList.add('active');} 
Â  Â  }
Â  Â  chargerHistoriqueChine();
}

async function chargerHistoriqueChine() {
Â  Â  const tb = document.getElementById('tbody-historique-chine');
Â  Â  if(!tb) return;
Â  Â  tb.innerHTML = '<tr><td colspan="8">Chargement...</td></tr>';
Â  Â  
Â  Â  const s = document.getElementById('search-hist-chine');
Â  Â  if(s) s.oninput = () => { const q = s.value.toLowerCase(); Array.from(tb.rows).forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none"); };

Â  Â  try {
Â  Â  Â  Â  const snap = await db.collection('expeditions').limit(200).get();
Â  Â  Â  Â  let docs=[]; snap.forEach(d=>docs.push({id:d.id, ...d.data()}));
Â  Â  Â  Â  docs.sort((a,b)=>(b.creeLe?b.creeLe.seconds:0)-(a.creeLe?a.creeLe.seconds:0));
Â  Â  Â  Â  
Â  Â  Â  Â  tb.innerHTML='';
Â  Â  Â  Â  docs.forEach(d => {
Â  Â  Â  Â  Â  Â  let m = false;
Â  Â  Â  Â  Â  Â  if(currentHistoriqueType==='maritime' && d.type==='maritime') m=true;
Â  Â  Â  Â  Â  Â  if(currentHistoriqueType==='aerien' && (d.type||"").startsWith('aerien')) m=true;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(m) {
Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = d.date ? new Date(d.date).toLocaleDateString('fr-FR') : '-';
Â  Â  Â  Â  Â  Â  Â  Â  let pv = (d.type||"").startsWith('aerien') ? d.poidsEnvoye+' Kg' : d.volumeEnvoye+' CBM';
Â  Â  Â  Â  Â  Â  Â  Â  let pB = parseInt((d.prixEstime||"0").replace(/\D/g,''))||0;
Â  Â  Â  Â  Â  Â  Â  Â  let final = pB - (d.remise||0);
Â  Â  Â  Â  Â  Â  Â  Â  let mod = d.dernierModificateur ? `<span class="modif-info">Par ${d.dernierModificateur}</span>` : '-';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // SÃ‰CURISATION DES DONNÃ‰ES POUR ONCLICK
Â  Â  Â  Â  Â  Â  Â  Â  const safeData = encodeURIComponent(JSON.stringify({id:d.id, ...d}));
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  Â  Â  tr.className = 'interactive-table-row';
Â  Â  Â  Â  Â  Â  Â  Â  tr.innerHTML = `<td>${d.reference}</td><td>${dateStr}</td><td>${d.nom}</td><td>${d.quantiteEnvoyee}</td><td>${pv}</td><td>${formatArgent(final)} CFA</td><td>${mod}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  tr.onclick = () => ouvrirModalModifViaData(safeData);
Â  Â  Â  Â  Â  Â  Â  Â  tb.appendChild(tr);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  } catch(e) { console.error(e); }
}

function ouvrirModalModifViaData(encodedData) {
Â  Â  const envoi = JSON.parse(decodeURIComponent(encodedData));
Â  Â  ouvrirModalModif(envoi);
}

const modalModif = document.getElementById('modal-modif-chine');
function ouvrirModalModif(envoi) {
Â  Â  currentModifEnvoi = envoi;
Â  Â  modalModif.style.display='flex';
Â  Â  document.getElementById('modif-client-titre').innerText = envoi.nom;
Â  Â  document.getElementById('modif-ref-titre').innerText = envoi.reference;
Â  Â  document.getElementById('modif-desc-titre').innerText = envoi.description;
Â  Â  
Â  Â  document.getElementById('modif-qte').value = envoi.quantiteEnvoyee;
Â  Â  document.getElementById('modif-remise').value = envoi.remise||0;
Â  Â  const elP = document.getElementById('modif-poids');
Â  Â  elP.value = (envoi.type||"").startsWith('aerien') ? envoi.poidsEnvoye : envoi.volumeEnvoye;
Â  Â  calculerPrixModif();
}

function calculerPrixModif() {
Â  Â  if(!currentModifEnvoi) return;
Â  Â  const v = parseFloat(document.getElementById('modif-poids').value)||0;
Â  Â  const r = parseInt(document.getElementById('modif-remise').value)||0;
Â  Â  let t = 0;
Â  Â  if(currentModifEnvoi.type==='aerien_normal') t=PRIX_AERIEN_NORMAL;
Â  Â  else if(currentModifEnvoi.type==='aerien_express') t=PRIX_AERIEN_EXPRESS;
Â  Â  else t=PRIX_MARITIME_CBM;
Â  Â  document.getElementById('modif-prix-final').value = formatArgent((v*t)-r)+' CFA';
}

async function sauvegarderModificationChine() {
Â  Â  if(!currentModifEnvoi) return;
Â  Â  const q = parseInt(document.getElementById('modif-qte').value)||0;
Â  Â  const v = parseFloat(document.getElementById('modif-poids').value)||0;
Â  Â  const r = parseInt(document.getElementById('modif-remise').value)||0;
Â  Â  
Â  Â  let up = { quantiteEnvoyee: q, remise: r, dernierModificateur: currentRole==='chine'?'Agence Chine':'Agence Abidjan', dateModification: firebase.firestore.FieldValue.serverTimestamp() };
Â  Â  if((currentModifEnvoi.type||"").startsWith('aerien')) up.poidsEnvoye=v; else up.volumeEnvoye=v;
Â  Â  
Â  Â  let t = 0;
Â  Â  if(currentModifEnvoi.type==='aerien_normal') t=PRIX_AERIEN_NORMAL;
Â  Â  else if(currentModifEnvoi.type==='aerien_express') t=PRIX_AERIEN_EXPRESS;
Â  Â  else t=PRIX_MARITIME_CBM;
Â  Â  up.prixEstime = formatArgent(v * t) + ' CFA';

Â  Â  try {
Â  Â  Â  Â  await db.collection('expeditions').doc(currentModifEnvoi.id).update(up);
Â  Â  Â  Â  alert('ModifiÃ©.'); modalModif.style.display='none'; chargerHistoriqueChine();
Â  Â  } catch(e) { alert(e.message); }
}
function fermerModalModif(e) { if(e.target===modalModif||e.target.classList.contains('modal-close')) modalModif.style.display='none'; }

// =======================================================
// 6. RECEPTION
// =======================================================
function ouvrirSousOngletReception(type) {
Â  Â  currentReceptionType = type;
Â  Â  const b1 = document.getElementById('btn-rec-maritime');
Â  Â  const b2 = document.getElementById('btn-rec-aerien');
Â  Â  if(b1&&b2) { 
Â  Â  Â  Â  if(type==='maritime'){b1.classList.add('active');b2.classList.remove('active');} 
Â  Â  Â  Â  else {b1.classList.remove('active');b2.classList.add('active');} 
Â  Â  }
Â  Â  chargerClients();
}

async function chargerClients() {
Â  Â  const tb = document.getElementById('liste-clients-tbody');
Â  Â  if(!tb) return;
Â  Â  tb.innerHTML='<tr><td colspan="9">Chargement...</td></tr>';
Â  Â  try {
Â  Â  Â  Â  const snap = await db.collection('expeditions').orderBy('creeLe', 'desc').get();
Â  Â  Â  Â  tb.innerHTML=''; clientsCharges=[];
Â  Â  Â  Â  snap.forEach(d => {
Â  Â  Â  Â  Â  Â  const data = d.data();
Â  Â  Â  Â  Â  Â  let match=false;
Â  Â  Â  Â  Â  Â  if(currentReceptionType==='maritime' && data.type==='maritime') match=true;
Â  Â  Â  Â  Â  Â  if(currentReceptionType==='aerien' && (data.type||"").startsWith('aerien')) match=true;
Â  Â  Â  Â  Â  Â  if(match) {
Â  Â  Â  Â  Â  Â  Â  Â  clientsCharges.push({id:d.id, ...data});
Â  Â  Â  Â  Â  Â  Â  Â  let pv = (data.type||"").startsWith('aerien') ? data.poidsEnvoye : data.volumeEnvoye;
Â  Â  Â  Â  Â  Â  Â  Â  let st = data.status || 'En attente';
Â  Â  Â  Â  Â  Â  Â  Â  let cl = st.includes('Conforme')?'status-conforme':st.includes('Ecart')?'status-ecart':st.includes('SupÃ©rieur')?'status-superieur':'status-attente';
Â  Â  Â  Â  Â  Â  Â  Â  let pN = (parseInt((data.prixEstime||"0").replace(/\D/g,''))||0) - (data.remise||0);
Â  Â  Â  Â  Â  Â  Â  Â  let dej = parseInt(data.montantPaye)||0;
Â  Â  Â  Â  Â  Â  Â  Â  let res = pN - dej;

Â  Â  Â  Â  Â  Â  Â  Â  // SÃ‰CURISATION DES DONNÃ‰ES POUR ONCLICK
Â  Â  Â  Â  Â  Â  Â  Â  const safeData = encodeURIComponent(JSON.stringify({id:d.id, ...data}));

Â  Â  Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  Â  Â  tr.className='interactive-table-row';
Â  Â  Â  Â  Â  Â  Â  Â  tr.innerHTML=`<td>${data.reference}</td><td>${data.date}</td><td>${data.nom}</td><td>${data.description||''}</td><td>${data.type}</td><td>${data.quantiteEnvoyee}</td><td>${pv}</td><td>${formatArgent(res)} CFA</td><td><span class="status-badge ${cl}">${st}</span></td>`;
Â  Â  Â  Â  Â  Â  Â  Â  tr.onclick = () => selectionnerClientViaData(safeData);
Â  Â  Â  Â  Â  Â  Â  Â  tb.appendChild(tr);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  } catch(e) { console.error(e); }
}

function selectionnerClientViaData(encodedData) {
Â  Â  const envoi = JSON.parse(decodeURIComponent(encodedData));
Â  Â  selectionnerClient(envoi);
}

// Modal Reception Variables
const modalBackdrop = document.getElementById('modal-backdrop');
function selectionnerClient(envoi) {
Â  Â  currentEnvoi = envoi;
Â  Â  modalBackdrop.style.display='flex';
Â  Â  
Â  Â  const set = (id,v) => { const e = document.getElementById(id); if(e) e.innerText=v; };
Â  Â  set('client-selectionne', envoi.nom);
Â  Â  set('ref-attendue', envoi.reference);
Â  Â  set('desc-attendue', envoi.description);
Â  Â  set('tel-attendue', envoi.tel);
Â  Â  const tEl = document.getElementById('tel-attendu'); if(tEl) tEl.innerText = envoi.tel;
Â  Â  set('qte-attendue', (envoi.quantiteEnvoyee||0)+' colis');

Â  Â  let isAir = (envoi.type||"").startsWith('aerien');
Â  Â  set('poids-attendu', (isAir?envoi.poidsEnvoye:envoi.volumeEnvoye) + (isAir?' Kg':' CBM'));

Â  Â  let pB = parseInt((envoi.prixEstime||"0").replace(/\D/g,''))||0;
Â  Â  let tot = pB - (envoi.remise||0);
Â  Â  let dej = parseInt(envoi.montantPaye)||0;
Â  Â  let res = tot - dej;
Â  Â  
Â  Â  set('prix-attendu', formatArgent(tot)+' CFA');
Â  Â  const elR = document.getElementById('prix-restant');
Â  Â  if(elR) {
Â  Â  Â  Â  if(res<=0) { elR.innerText="SOLDÃ‰"; elR.style.color="green"; document.getElementById('montant-paye').value=0; }
Â  Â  Â  Â  else { elR.innerText=formatArgent(res)+' CFA'; elR.style.color="#dc3545"; document.getElementById('montant-paye').value=res; }
Â  Â  }

Â  Â  const phDiv = document.getElementById('photos-recues-apercu');
Â  Â  if(phDiv) {
Â  Â  Â  Â  phDiv.innerHTML = '';
Â  Â  Â  Â  if(envoi.photosURLs && envoi.photosURLs.length > 0) {
Â  Â  Â  Â  Â  Â  document.getElementById('photos-recues-container').style.display='block';
Â  Â  Â  Â  Â  Â  envoi.photosURLs.forEach(u => { const i=document.createElement('img'); i.src=u; phDiv.appendChild(i); });
Â  Â  Â  Â  } else document.getElementById('photos-recues-container').style.display='none';
Â  Â  }

Â  Â  document.getElementById('quantite-recue').value='';
Â  Â  document.getElementById('poids-recu').value='';
Â  Â  const lb = document.getElementById('label-poids-recu');
Â  Â  if(lb) lb.innerText = isAir ? "Poids ReÃ§u (Kg)" : "Vol ReÃ§u (CBM)";

Â  Â  updateModalStatus(envoi);
}

function updateModalStatus(envoi) {
Â  Â  const st = envoi.status || 'En attente';
Â  Â  const el = document.getElementById('reception-status');
Â  Â  if(el) {
Â  Â  Â  Â  el.innerText = st;
Â  Â  Â  Â  el.className = 'status-badge ' + (st.includes('Conforme')?'status-conforme':st.includes('Ecart')?'status-ecart':'status-attente');
Â  Â  }
Â  Â  const sum = document.getElementById('reception-summary');
Â  Â  if(sum) sum.innerHTML = `ReÃ§u: <strong>${envoi.quantiteRecue||0} colis</strong> | <strong>${envoi.poidsRecu||0}</strong>`;
}
function fermerModal(e) { if(e.target===modalBackdrop||e.target.classList.contains('modal-close')||e.target.classList.contains('btn-secondaire')) modalBackdrop.style.display='none'; }

async function enregistrerReception() {
Â  Â  if(!currentEnvoi) return;
Â  Â  const q = parseInt(document.getElementById('quantite-recue').value)||0;
Â  Â  const p = parseFloat(document.getElementById('poids-recu').value)||0;
Â  Â  const m = parseInt(document.getElementById('montant-paye').value)||0;
Â  Â  const via = document.getElementById('moyen-paiement').value;
Â  Â  
Â  Â  const nQ = (currentEnvoi.quantiteRecue||0)+q;
Â  Â  const nP = (currentEnvoi.poidsRecu||0)+p;
Â  Â  const nM = (currentEnvoi.montantPaye||0)+m;
Â  Â  
Â  Â  let st = 'ReÃ§u - Conforme';
Â  Â  const diffQ = nQ - currentEnvoi.quantiteEnvoyee;
Â  Â  const diffP = nP - ((currentEnvoi.type||"").startsWith('aerien')?currentEnvoi.poidsEnvoye:currentEnvoi.volumeEnvoye);
Â  Â  
Â  Â  if(diffQ < 0) st = 'ReÃ§u - Ecart';
Â  Â  else if(diffQ > 0) st = 'ReÃ§u - SupÃ©rieur';
Â  Â  else { if(Math.abs(diffP) > 0.1) st = (diffP>0?'ReÃ§u - SupÃ©rieur':'ReÃ§u - Ecart'); else st = 'ReÃ§u - Conforme'; }
Â  Â  
Â  Â  let agent = currentUser ? (currentRole==='abidjan'?"AGENCE ABIDJAN":currentUser.email) : "Inconnu";
Â  Â  let up = { quantiteRecue:nQ, poidsRecu:nP, montantPaye:nM, status:st, moyenPaiement:via, datePaiement: firebase.firestore.FieldValue.serverTimestamp() };
Â  Â  if(m>0) up.historiquePaiements = firebase.firestore.FieldValue.arrayUnion({ date: firebase.firestore.Timestamp.now(), montant:m, moyen:via, agent:agent });
Â  Â  
Â  Â  await db.collection('expeditions').doc(currentEnvoi.id).update(up);
Â  Â  alert('ValidÃ©'); modalBackdrop.style.display='none'; chargerClients();
}

// =======================================================
// 7. COMPTA
// =======================================================
function ouvrirSousOngletCompta(type) {
Â  Â  currentComptaType = type;
Â  Â  const b1 = document.querySelector('#Comptabilite .sub-nav-link:first-child');
Â  Â  const b2 = document.querySelector('#Comptabilite .sub-nav-link:last-child');
Â  Â  if(b1&&b2) { if(type==='maritime'){b1.classList.add('active');b2.classList.remove('active');} else {b1.classList.remove('active');b2.classList.add('active');} }
Â  Â  chargerCompta(type);
}

async function chargerCompta(type) {
Â  Â  const tb = document.getElementById('tbody-compta'); if(!tb) return;
Â  Â  tb.innerHTML='<tr><td colspan="10">Chargement...</td></tr>';
Â  Â  try {
Â  Â  Â  Â  const snapE = await db.collection('expeditions').get();
Â  Â  Â  Â  const snapS = await db.collection('depenses').orderBy('date','desc').get();
Â  Â  Â  Â  let items = [];
Â  Â  Â  Â  snapE.forEach(d => {
Â  Â  Â  Â  Â  Â  const data = d.data();
Â  Â  Â  Â  Â  Â  let match=false;
Â  Â  Â  Â  Â  Â  if(type==='maritime' && data.type==='maritime') match=true;
Â  Â  Â  Â  Â  Â  if(type==='aerien' && (data.type||"").startsWith('aerien')) match=true;
Â  Â  Â  Â  Â  Â  if(match) {
Â  Â  Â  Â  Â  Â  Â  Â  let dRef = data.datePaiement ? data.datePaiement.toDate() : new Date(data.date);
Â  Â  Â  Â  Â  Â  Â  Â  let grp = data.refGroupe || "ZZZ";
Â  Â  Â  Â  Â  Â  Â  Â  if(grp==="ZZZ" && data.reference) { let pts=data.reference.split('-'); if(pts.length>0 && pts[pts.length-1].startsWith('EV')) grp=pts[pts.length-1]; }
Â  Â  Â  Â  Â  Â  Â  Â  items.push({ ...data, id:d.id, isDep:false, sortDate:dRef, grp:grp, sortRef:data.reference||"ZZZ", hist:data.historiquePaiements||[] });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  snapS.forEach(d => {
Â  Â  Â  Â  Â  Â  const data = d.data();
Â  Â  Â  Â  Â  Â  if(data.type===type) {
Â  Â  Â  Â  Â  Â  Â  Â  let g = (data.refGroupe && data.refGroupe.trim()) ? data.refGroupe.toUpperCase() : "ZZZ_GEN";
Â  Â  Â  Â  Â  Â  Â  Â  items.push({ ...data, id:d.id, isDep:true, sortDate:new Date(data.date), grp:g, sortRef:"DEPENSE" });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  items.sort((a,b) => {
Â  Â  Â  Â  Â  Â  if(a.grp.startsWith('EV') && b.grp.startsWith('EV')) return parseInt(a.grp.replace('EV','')) - parseInt(b.grp.replace('EV',''));
Â  Â  Â  Â  Â  Â  return a.grp.localeCompare(b.grp);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  let cred=0, caisse=0, bonus=0;
Â  Â  Â  Â  let modes={Esp:0,Chq:0,OM:0,Wav:0,CB:0}, outM={Esp:0,Chq:0,OM:0,Wav:0,CB:0};
Â  Â  Â  Â  let curGrp=null, grpDu=0, grpReste=0, grpEntree=0, grpSortie=0;
Â  Â  Â  Â  tb.innerHTML='';
Â  Â  Â  Â  
Â  Â  Â  Â  items.forEach((it, idx) => {
Â  Â  Â  Â  Â  Â  if(curGrp!==null && it.grp!==curGrp && !curGrp.startsWith('ZZZ')) {
Â  Â  Â  Â  Â  Â  Â  Â  tb.innerHTML += `<tr class="group-summary-row"><td colspan="4">TOTAL ${curGrp}</td><td>${formatArgent(grpDu)}</td><td>${formatArgent(grpReste)}</td><td>${formatArgent(grpEntree)}</td><td>${formatArgent(grpSortie)}</td><td></td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  grpDu=0; grpReste=0; grpEntree=0; grpSortie=0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  curGrp = it.grp;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let dS = it.sortDate.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
Â  Â  Â  Â  Â  Â  let rowClass = `row-month-${it.sortDate.getMonth()}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(it.isDep) {
Â  Â  Â  Â  Â  Â  Â  Â  let m = parseFloat(it.montant)||0;
Â  Â  Â  Â  Â  Â  Â  Â  caisse -= m; grpSortie += m;
Â  Â  Â  Â  Â  Â  Â  Â  let v = it.moyenPaiement || 'EspÃ¨ce';
Â  Â  Â  Â  Â  Â  Â  Â  if(v.includes('ChÃ¨que')) outM.Chq+=m; else if(v.includes('OM')) outM.OM+=m; else if(v.includes('Wave')) outM.Wav+=m; else if(v.includes('CB')) outM.CB+=m; else outM.Esp+=m;
Â  Â  Â  Â  Â  Â  Â  Â  tb.innerHTML += `<tr class="${rowClass}"><td>${dS}</td><td>-</td><td>${it.motif}</td><td>DÃ©pense</td><td>-</td><td>-</td><td>-</td><td class="text-red">${formatArgent(m)}</td><td><button class="btn-suppr-small" onclick="supprimerDepense('${it.id}')">X</button></td></tr>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let pB = parseInt((it.prixEstime||"0").replace(/\D/g,''))||0;
Â  Â  Â  Â  Â  Â  Â  Â  let du = pB - (it.remise||0);
Â  Â  Â  Â  Â  Â  Â  Â  let paye = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if(it.hist.length>0) it.hist.forEach(h => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let v=parseFloat(h.montant); paye+=v;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let t=h.moyen||'EspÃ¨ce';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.includes('ChÃ¨que')) modes.Chq+=v; else if(t.includes('OM')) modes.OM+=v; else if(t.includes('Wave')) modes.Wav+=v; else if(t.includes('CB')) modes.CB+=v; else modes.Esp+=v;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  else { paye = it.montantPaye||0; modes.Esp+=paye; }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  let r = du - paye;
Â  Â  Â  Â  Â  Â  Â  Â  caisse += paye;
Â  Â  Â  Â  Â  Â  Â  Â  if(r>0) cred+=r;
Â  Â  Â  Â  Â  Â  Â  Â  let diff = paye - du;
Â  Â  Â  Â  Â  Â  Â  Â  if(diff>0) bonus+=diff; else if(diff<0 && Math.abs(diff)<500) bonus+=diff;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  grpDu+=du; grpReste+=(r>0?r:0); grpEntree+=paye;

Â  Â  Â  Â  Â  Â  Â  Â  // SÃ‰CURISATION DATA POUR ONCLICK
Â  Â  Â  Â  Â  Â  Â  Â  const safeData = encodeURIComponent(JSON.stringify({id:it.id, nom:it.nom, reference:it.reference, history:it.hist}));

Â  Â  Â  Â  Â  Â  Â  Â  tb.innerHTML += `<tr class="${rowClass} interactive-table-row" onclick='voirHistoriquePaiementViaData("${safeData}")'><td>${dS}</td><td>${it.reference}</td><td>${it.description}</td><td>${it.nom}</td><td>${formatArgent(du)}</td><td style="color:${r>0?'red':'green'}">${formatArgent(r)}</td><td class="text-green">${formatArgent(paye)}</td><td>-</td><td><i class="fas fa-eye"></i></td></tr>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  if(curGrp && !curGrp.startsWith('ZZZ')) tb.innerHTML += `<tr class="group-summary-row"><td colspan="4">TOTAL ${curGrp}</td><td>${formatArgent(grpDu)}</td><td>${formatArgent(grpReste)}</td><td>${formatArgent(grpEntree)}</td><td>${formatArgent(grpSortie)}</td><td></td></tr>`;

Â  Â  Â  Â  document.getElementById('total-credit').innerText = formatArgent(cred)+' CFA';
Â  Â  Â  Â  document.getElementById('total-caisse').innerText = formatArgent(caisse)+' CFA';
Â  Â  Â  Â  document.getElementById('total-bonus').innerText = formatArgent(bonus)+' CFA';
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('pay-espece-in').innerText = formatArgent(modes.Esp); document.getElementById('pay-espece-out').innerText = formatArgent(outM.Esp);
Â  Â  Â  Â  document.getElementById('pay-cheque-in').innerText = formatArgent(modes.Chq); document.getElementById('pay-cheque-out').innerText = formatArgent(outM.Chq);
Â  Â  Â  Â  document.getElementById('pay-om-in').innerText = formatArgent(modes.OM); document.getElementById('pay-om-out').innerText = formatArgent(outM.OM);
Â  Â  Â  Â  document.getElementById('pay-wave-in').innerText = formatArgent(modes.Wav); document.getElementById('pay-wave-out').innerText = formatArgent(outM.Wav);
Â  Â  Â  Â  document.getElementById('pay-cb-in').innerText = formatArgent(modes.CB); document.getElementById('pay-cb-out').innerText = formatArgent(outM.CB);
Â  Â  Â  Â  
Â  Â  Â  Â  let tIn = Object.values(modes).reduce((a,b)=>a+b,0); let tOut = Object.values(outM).reduce((a,b)=>a+b,0);
Â  Â  Â  Â  document.getElementById('pay-total-in').innerText = formatArgent(tIn); document.getElementById('pay-total-out').innerText = formatArgent(tOut);
Â  Â  } catch(e) { console.error(e); }
}

function voirHistoriquePaiementViaData(encoded) {
Â  Â  const item = JSON.parse(decodeURIComponent(encoded));
Â  Â  voirHistoriquePaiement(item);
}

// MODALS UTILITAIRES
const modalHist = document.getElementById('modal-historique');
function voirHistoriquePaiement(item) {
Â  Â  if(item.isDepense) return;
Â  Â  modalHist.style.display='flex';
Â  Â  document.getElementById('hist-client-nom').innerText = item.nom;
Â  Â  document.getElementById('hist-ref').innerText = item.reference;
Â  Â  const tb = document.getElementById('tbody-historique'); tb.innerHTML = '';
Â  Â  if(item.history && item.history.length>0){
Â  Â  Â  Â  item.history.forEach(h => {
Â  Â  Â  Â  Â  Â  let d = new Date(h.date.seconds*1000).toLocaleDateString('fr-FR');
Â  Â  Â  Â  Â  Â  let agent = h.agent || '-';
Â  Â  Â  Â  Â  Â  tb.innerHTML += `<tr><td>${d}</td><td class="text-green">${formatArgent(parseInt(h.montant))} CFA</td><td>${h.moyen}</td></tr>`;
Â  Â  Â  Â  });
Â  Â  } else { tb.innerHTML='<tr><td colspan="3">Aucun historique.</td></tr>'; }
}
function fermerModalHistorique(e) { if(e.target===modalHist||e.target.classList.contains('modal-close')||e.target.classList.contains('btn-secondaire')) modalHist.style.display='none'; }

const modalDepense = document.getElementById('modal-depense');
function ouvrirModalDepense() { modalDepense.style.display = 'flex'; }
function fermerModalDepense(e) { if(e.target===modalDepense||e.target.classList.contains('modal-close')) modalDepense.style.display='none'; }
async function enregistrerDepense() {
Â  Â  const date = document.getElementById('depense-date').value;
Â  Â  const type = document.getElementById('depense-type').value;
Â  Â  const motif = document.getElementById('depense-motif').value;
Â  Â  const grp = document.getElementById('depense-groupe').value.toUpperCase().trim();
Â  Â  const montant = parseFloat(document.getElementById('depense-montant').value)||0;
Â  Â  const moyen = document.getElementById('depense-moyen').value;
Â  Â  if(!date || !motif || montant<=0) { alert("Erreur saisie."); return; }
Â  Â  try {
Â  Â  Â  Â  await db.collection('depenses').add({ date, type, refGroupe: grp, motif, montant, moyenPaiement: moyen, creeLe: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  Â  alert("EnregistrÃ©."); modalDepense.style.display='none'; document.getElementById('form-depense').reset();
Â  Â  Â  Â  if(document.getElementById('Comptabilite').style.display==='block') chargerCompta(currentComptaType);
Â  Â  } catch(e){ alert(e.message); }
}
async function supprimerDepense(id) {
Â  Â  if(confirm("Supprimer ?")) { await db.collection('depenses').doc(id).delete(); chargerCompta(currentComptaType); }
}

// CHARGEURS LOGO & PDF
function chargerLogo() {
Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  const img = new Image(); img.src = '/logo_amt.png';
Â  Â  Â  Â  img.onload = () => resolve(img); img.onerror = () => resolve(null);
Â  Â  });
}
// --- NOUVELLE ETIQUETTE (STYLE STICKER) ---
async function genererEtiquette() {
Â  Â  if (!currentEnvoi) return;
Â  Â  const { jsPDF } = window.jspdf;
Â  Â  // Format Ã©tiquette (A6 paysage environ 105x148mm, adaptÃ© ici en 100x65mm pour le sticker)
Â  Â  const doc = new jsPDF('l', 'mm', [100, 65]); 
Â  Â  const logo = await chargerLogo();
Â  Â  
Â  Â  // Cadre Orange Double
Â  Â  doc.setDrawColor(255, 165, 0); // Orange
Â  Â  doc.setLineWidth(1.5);
Â  Â  doc.rect(2, 2, 96, 61); // Cadre extÃ©rieur
Â  Â  doc.setLineWidth(0.5);
Â  Â  doc.rect(4, 4, 92, 57); // Cadre intÃ©rieur fin

Â  Â  // En-tÃªte
Â  Â  if (logo) doc.addImage(logo, 'PNG', 6, 6, 13, 13);
Â  Â  
Â  Â  doc.setTextColor(255, 140, 0); // Orange Texte
Â  Â  doc.setFontSize(16); 
Â  Â  doc.setFont("helvetica", "bold");
Â  Â  doc.text("amt TRANSIT CARGO", 22, 12);
Â  Â  
Â  Â  doc.setTextColor(0); // Noir
Â  Â  doc.setFontSize(9);
Â  Â  doc.text("+225 89 84 46 57", 22, 17);
Â  Â  
Â  Â  // Lettre N (ou Ref courte)
Â  Â  doc.setFontSize(20); 
Â  Â  doc.text("N", 85, 15); 

Â  Â  // Lignes de sÃ©paration et infos
Â  Â  doc.setDrawColor(0); 
Â  Â  doc.setLineWidth(0.1);
Â  Â  
Â  Â  let y = 24; const x = 8;
Â  Â  const lineW = 85; // Largeur des lignes de pointillÃ© simulÃ©es
Â  Â  
Â  Â  // EXPEDITEUR
Â  Â  doc.setFontSize(8); doc.setFont("helvetica", "bold");
Â  Â  doc.text("EXPEDITEUR", x, y); y+=4;
Â  Â  doc.setFont("helvetica", "normal");
Â  Â  doc.text(`NOM ET PRENOM: ${currentEnvoi.expediteur || 'AMT TRANSIT CARGO'}`, x, y);
Â  Â  doc.line(x, y+1, x+lineW, y+1); y+=5; // Ligne de soulignement
Â  Â  
Â  Â  doc.text(`NUMERO: ${currentEnvoi.telExpediteur || '+225 0703165050'}`, x, y);
Â  Â  doc.line(x, y+1, x+lineW, y+1); y+=6;

Â  Â  // DESTINATAIRE
Â  Â  doc.setFont("helvetica", "bold");
Â  Â  doc.text("DESTINATAIRE", x, y); y+=4;
Â  Â  doc.setFont("helvetica", "normal");
Â  Â  doc.text(`NOM ET PRENOM: ${currentEnvoi.prenom} ${currentEnvoi.nom}`, x, y);
Â  Â  doc.line(x, y+1, x+lineW, y+1); y+=5;
Â  Â  
Â  Â  doc.text(`NUMERO: ${currentEnvoi.tel}`, x, y);
Â  Â  doc.line(x, y+1, x+lineW, y+1); y+=5;

Â  Â  // KILOS / COLIS
Â  Â  let pv = (currentEnvoi.type||"").startsWith('aerien') ? `${currentEnvoi.poidsEnvoye} Kg` : `${currentEnvoi.volumeEnvoye} CBM`;
Â  Â  doc.text(`KILOS: ${pv} Â | Â COLIS: ${currentEnvoi.quantiteEnvoyee}`, x, y);
Â  Â  doc.line(x, y+1, x+lineW, y+1); y+=5;
Â  Â  
Â  Â  // Footer (NumÃ©ros Chine/CI)
Â  Â  doc.setFontSize(7); doc.setFont("helvetica", "bold");
Â  Â  // CentrÃ© en bas
Â  Â  doc.text("+8619515284352 Â  Â  Â +2250703165050", 50, 58, {align: 'center'});

Â  Â  doc.save(`Etiquette_${currentEnvoi.nom}.pdf`);
}
// --- NOUVELLE FACTURE (AVEC HISTORIQUE DÃ‰TAILLÃ‰) ---
async function genererFacture() {
Â  Â  if (!currentEnvoi) return;
Â  Â  const { jsPDF } = window.jspdf; 
Â  Â  const doc = new jsPDF('p', 'mm', 'a4');
Â  Â  const logo = await chargerLogo();
Â  Â  
Â  Â  // En-tÃªte
Â  Â  if (logo) doc.addImage(logo, 'PNG', 10, 10, 30, 30);
Â  Â  doc.setFontSize(18); doc.setTextColor(21, 96, 158); doc.setFont("helvetica", "bold");
Â  Â  doc.text("AMT TRANSIT CARGO", 50, 20);
Â  Â  doc.setFontSize(10); doc.setTextColor(0); doc.setFont("helvetica", "normal");
Â  Â  doc.text("Agence: Abidjan - Chine", 50, 26);
Â  Â  doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 50, 32);
Â  Â  doc.line(10, 42, 200, 42); // Ligne de sÃ©paration

Â  Â  let y = 50;
Â  Â  
Â  Â  // Infos Client
Â  Â  doc.setFontSize(11); doc.setFont("helvetica", "bold"); 
Â  Â  doc.text("INFORMATIONS CLIENT", 10, y); y+=6;
Â  Â  doc.setFont("helvetica", "normal");
Â  Â  doc.text(`Nom: ${currentEnvoi.prenom} ${currentEnvoi.nom}`, 10, y); y+=5;
Â  Â  doc.text(`TÃ©l: ${currentEnvoi.tel}`, 10, y); y+=5;
Â  Â  doc.text(`RÃ©f: ${currentEnvoi.reference}`, 10, y); y+=10;

Â  Â  // TABLEAU 1 : SERVICES (Le colis)
Â  Â  const headers1 = [["SERVICES", "DESCRIPTION", "QUANTITE", "PRIX UNITAIRE", "PRIX TOTAL"]];
Â  Â  
Â  Â  let pBrut = parseInt((currentEnvoi.prixEstime||"0").replace(/\D/g,''))||0;
Â  Â  let pNet = pBrut - (currentEnvoi.remise||0);
Â  Â  let vol = (currentEnvoi.type||"").startsWith('aerien') ? currentEnvoi.poidsEnvoye : currentEnvoi.volumeEnvoye;
Â  Â  // Calcul PU fictif pour affichage
Â  Â  let pu = vol > 0 ? (pNet / vol).toFixed(0) : 0;

Â  Â  const data1 = [[ 
Â  Â  Â  Â  (currentEnvoi.type||"").toUpperCase(), 
Â  Â  Â  Â  currentEnvoi.description || '-', 
Â  Â  Â  Â  `${currentEnvoi.quantiteEnvoyee} Colis / ${vol}`, 
Â  Â  Â  Â  formatArgent(pu), 
Â  Â  Â  Â  formatArgent(pNet) 
Â  Â  ]];

Â  Â  doc.autoTable({ 
Â  Â  Â  Â  startY: y, 
Â  Â  Â  Â  head: headers1, 
Â  Â  Â  Â  body: data1, 
Â  Â  Â  Â  theme: 'grid', 
Â  Â  Â  Â  headStyles: { fillColor: [21, 96, 158] },
Â  Â  Â  Â  styles: { valign: 'middle' }
Â  Â  });

Â  Â  y = doc.lastAutoTable.finalY + 10;

Â  Â  // TABLEAU 2 : HISTORIQUE PAIEMENTS (AJOUTÃ‰ ICI)
Â  Â  doc.setFontSize(11); doc.setFont("helvetica", "bold");
Â  Â  doc.text("HISTORIQUE DES PAIEMENTS", 10, y);
Â  Â  y += 5;

Â  Â  const headers2 = [["DATE", "PRIX TOTAL", "MNT. PAYE", "RESTANT", "AGENT"]];
Â  Â  let histRows = [];
Â  Â  let cumul = 0;
Â  Â  
Â  Â  // Si historique existe
Â  Â  if(currentEnvoi.historiquePaiements && currentEnvoi.historiquePaiements.length > 0) {
Â  Â  Â  Â  // Tri par date
Â  Â  Â  Â  let sorted = currentEnvoi.historiquePaiements.sort((a,b) => a.date.seconds - b.date.seconds);
Â  Â  Â  Â  
Â  Â  Â  Â  sorted.forEach(h => {
Â  Â  Â  Â  Â  Â  let m = parseInt(h.montant)||0;
Â  Â  Â  Â  Â  Â  cumul += m;
Â  Â  Â  Â  Â  Â  let resteALinstantT = pNet - cumul;
Â  Â  Â  Â  Â  Â  let dateStr = new Date(h.date.seconds*1000).toLocaleString('fr-FR');
Â  Â  Â  Â  Â  Â  let agent = h.agent || "-";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  histRows.push([
Â  Â  Â  Â  Â  Â  Â  Â  dateStr,
Â  Â  Â  Â  Â  Â  Â  Â  formatArgent(pNet), // Le prix total ne change pas
Â  Â  Â  Â  Â  Â  Â  Â  `${formatArgent(m)} (${h.moyen})`, // Montant payÃ© cette fois-ci + moyen
Â  Â  Â  Â  Â  Â  Â  Â  formatArgent(resteALinstantT), // Reste aprÃ¨s ce paiement
Â  Â  Â  Â  Â  Â  Â  Â  agent
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  // Cas anciens dossiers sans historique dÃ©taillÃ©
Â  Â  Â  Â  let deja = parseInt(currentEnvoi.montantPaye)||0;
Â  Â  Â  Â  if(deja > 0) {
Â  Â  Â  Â  Â  Â  histRows.push(["-", formatArgent(pNet), formatArgent(deja), formatArgent(pNet - deja), "Ancien SystÃ¨me"]);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â histRows.push(["-", formatArgent(pNet), "0", formatArgent(pNet), "-"]);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  doc.autoTable({
Â  Â  Â  Â  startY: y,
Â  Â  Â  Â  head: headers2,
Â  Â  Â  Â  body: histRows,
Â  Â  Â  Â  theme: 'striped', // Style rayÃ© pour diffÃ©rencier
Â  Â  Â  Â  headStyles: { fillColor: [50, 50, 50] }, // Gris foncÃ© pour distinguer
Â  Â  Â  Â  styles: { fontSize: 9 }
Â  Â  });
Â  Â  
Â  Â  // TOTAUX FINAUX
Â  Â  y = doc.lastAutoTable.finalY + 10;
Â  Â  let dejaPayeTotal = parseInt(currentEnvoi.montantPaye)||0;
Â  Â  let resteFinal = pNet - dejaPayeTotal;

Â  Â  // Petit tableau rÃ©capitulatif Ã  droite
Â  Â  doc.autoTable({
Â  Â  Â  Â  startY: y,
Â  Â  Â  Â  body: [
Â  Â  Â  Â  Â  Â  ["NET Ã€ PAYER", formatArgent(pNet) + " CFA"],
Â  Â  Â  Â  Â  Â  ["TOTAL PAYÃ‰", formatArgent(dejaPayeTotal) + " CFA"],
Â  Â  Â  Â  Â  Â  ["RESTE DÃ›", formatArgent(resteFinal) + " CFA"]
Â  Â  Â  Â  ],
Â  Â  Â  Â  theme: 'plain',
Â  Â  Â  Â  styles: { fontSize: 10, fontStyle: 'bold', halign: 'right', cellPadding: 2 },
Â  Â  Â  Â  columnStyles: { 0: { halign: 'left', cellWidth: 40, fillColor: [240, 240, 240] } },
Â  Â  Â  Â  margin: { left: 130 } // AlignÃ© Ã  droite
Â  Â  });

Â  Â  // Footer
Â  Â  y = doc.lastAutoTable.finalY + 20;
Â  Â  doc.setTextColor(150); doc.setFontSize(8); doc.setFont("helvetica", "normal");
Â  Â  doc.text("Merci de votre confiance - AMT Transit Cargo", 105, y, {align: 'center'});
Â  Â  doc.text("RC: 929 865 103 | SiÃ¨ge: Abidjan", 105, y+4, {align: 'center'});

Â  Â  doc.save(`Facture_${currentEnvoi.nom}.pdf`);
}
style.css
/* =================================== */
/* STYLES DE BASE & TYPOGRAPHIE Â  Â  Â  Â */
/* =================================== */
body {
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  margin: 0;
Â  Â  padding: 0;
Â  Â  background-color: #f0f2f5;
Â  Â  color: #333;
Â  Â  line-height: 1.3; /* Lignes de texte plus serrÃ©es */
Â  Â  font-size: 12px; Â /* Texte plus petit (style Excel) */
}
main {
Â  Â  padding: 5px; /* Marges externes minimales */
Â  Â  max-width: 100%; /* Utilise tout l'Ã©cran */
Â  Â  margin: 0 auto;
}
h1, h2, h3 { color: #1a1a1a; }
h2 {
Â  Â  font-size: 1.3em;
Â  Â  margin-top: 0;
Â  Â  border-bottom: 1px solid #ccc;
Â  Â  padding-bottom: 3px;
Â  Â  margin-bottom: 8px;
}
h3 {
Â  Â  font-size: 1.1em;
Â  Â  color: #15609e;
Â  Â  margin-bottom: 5px;
Â  Â  margin-top: 0;
}
.card {
Â  Â  background-color: #fff;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 4px;
Â  Â  padding: 10px; /* Moins d'espace dans les cartes */
Â  Â  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
Â  Â  margin-bottom: 8px;
}

/* =================================== */
/* HEADER & NAV Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â */
/* =================================== */
header {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  background-color: #fff;
Â  Â  padding: 2px 15px;
Â  Â  border-bottom: 1px solid #ccc;
Â  Â  height: 40px; /* Header plus fin */
}
.logo { height: 30px; }
.header-info { font-size: 0.9em; color: #555; }

.main-nav {
Â  Â  display: flex;
Â  Â  background-color: #15609e;
Â  Â  padding: 0 5px;
Â  Â  height: 35px; /* Barre nav plus fine */
Â  Â  align-items: flex-end;
}
.nav-link {
Â  Â  background-color: transparent;
Â  Â  border: none;
Â  Â  outline: none;
Â  Â  cursor: pointer;
Â  Â  padding: 8px 15px;
Â  Â  font-size: 1em;
Â  Â  font-weight: bold;
Â  Â  color: #e0e0e0;
Â  Â  border-bottom: 3px solid transparent;
}
.nav-link:hover { background-color: #1e7fc9; color: #fff; }
.nav-link.active {
Â  Â  background-color: #fff;
Â  Â  color: #15609e;
Â  Â  border-bottom: 3px solid #f0a500;
Â  Â  padding-bottom: 8px;
}
.page-content { display: none; animation: fadeIn 0.2s; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
.info-text { font-size: 0.9em; color: #666; font-style: italic; margin-bottom: 5px; margin-top: -5px;}

/* =================================== */
/* FORMULAIRES (ULTRA COMPACTS) Â  Â  Â  Â */
/* =================================== */
.form-group {
Â  Â  margin-bottom: 5px; /* TrÃ¨s peu d'espace entre les champs */
}
.form-group label {
Â  Â  display: block;
Â  Â  margin-bottom: 1px;
Â  Â  font-weight: 700;
Â  Â  color: #444;
Â  Â  font-size: 0.95em;
}
.form-group input, .form-group select {
Â  Â  width: 100%;
Â  Â  padding: 2px 5px; /* Padding interne minimal */
Â  Â  border: 1px solid #999;
Â  Â  border-radius: 2px;
Â  Â  box-sizing: border-box;
Â  Â  font-size: 1em;
Â  Â  height: 26px; /* Champ trÃ¨s fin */
}
.form-group input:focus, .form-group select:focus {
Â  Â  outline: none; border-color: #15609e;
}

/* =================================== */
/* BOUTONS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  */
/* =================================== */
.export-buttons { display: flex; gap: 5px; margin-bottom: 5px; }
.export-buttons button { width: auto; padding: 4px 8px; font-size: 0.9em; }

button {
Â  Â  cursor: pointer;
Â  Â  border: none;
Â  Â  border-radius: 3px;
Â  Â  padding: 6px 12px;
Â  Â  font-size: 1em;
Â  Â  font-weight: bold;
Â  Â  transition: all 0.1s ease;
}
.btn-principal { background-color: #15609e; color: white; width: 100%; margin-top: 5px; }
.btn-principal:hover { background-color: #125a96; }
.btn-secondaire { background-color: #6c757d; color: white; width: 100%; margin-top: 5px; }
.btn-secondaire:hover { background-color: #5a6268; }
.btn-small { width: auto; padding: 4px 8px; font-size: 0.9em; }
.btn-suppr-small { background: #dc3545; color: white; padding: 1px 5px; font-size: 10px; border-radius: 2px; height: 20px; line-height: 18px;}

hr { border: none; border-top: 1px solid #ddd; margin: 10px 0; }
#prix-calcule, .prix-final { font-size: 1.1em; font-weight: 700; color: #28a745; }

/* =================================== */
/* TABLEAUX (STYLE EXCEL) Â  Â  Â  Â  Â  Â  Â */
/* =================================== */
.table-container { overflow-x: auto; }
table {
Â  Â  width: 100%;
Â  Â  border-collapse: collapse;
Â  Â  margin-top: 5px;
Â  Â  font-size: 1em; /* HÃ©rite du 12px du body */
Â  Â  background-color: #fff;
}
/* En-tÃªtes et Cellules trÃ¨s serrÃ©s */
th, td {
Â  Â  padding: 3px 5px; /* L'espace vital minimum */
Â  Â  text-align: left;
Â  Â  border: 1px solid #ccc; /* Bordures plus visibles comme Excel */
Â  Â  white-space: nowrap; /* EmpÃªche le texte de passer Ã  la ligne */
}
th {
Â  Â  background-color: #e6e6e6;
Â  Â  color: #000;
Â  Â  font-weight: bold;
Â  Â  text-transform: uppercase;
Â  Â  font-size: 0.9em;
}
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:hover { background-color: #e3f2fd; }

/* Actions */
.btn-action { display: inline-block; padding: 1px 6px; font-size: 0.85em; margin: 0 1px; border-radius: 2px; }
.btn-afficher { background-color: #28a745; color: white; }
.btn-supprimer { background-color: #dc3545; color: white; }

/* Tableau Compta SpÃ©cifique */
.excel-table th { background-color: #4472c4; color: white; border: 1px solid #fff; }
.excel-table td { text-align: center; }
.excel-table td:nth-child(6) { color: #c0392b; font-weight: bold; } /* Reste */
.excel-table td:nth-child(7) { color: #27ae60; font-weight: bold; } /* EntrÃ©e */
.excel-table td:nth-child(8) { color: #c0392b; font-weight: bold; } /* Sortie */

/* LIGNE TOTAL GROUPE (CORRIGÃ‰E) */
tr.group-summary-row {
Â  Â  background-color: #747272 !important; /* Gris sombre */
}
tr.group-summary-row td {
Â  Â  color: rgb(0, 255, 255) !important; /* Vert Florissant (Cyan) */
Â  Â  font-weight: bold;
Â  Â  border: 1px solid #555;
Â  Â  text-align: center;
Â  Â  font-size: 1.1em; /* Un peu plus gros */
}

/* =================================== */
/* BADGES & DASHBOARD Â  Â  Â  Â  Â  Â  Â  Â  Â */
/* =================================== */
.status-badge { padding: 2px 6px; border-radius: 3px; font-size: 0.85em; font-weight: bold; color: #fff; display: inline-block; }
.status-attente { background-color: #6c757d; }
.status-conforme { background-color: #28a745; }
.status-ecart { background-color: #dc3545; }
.status-superieur { background-color: #15609e; }

.dashboard-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; margin-bottom: 10px; }
.summary-row {
Â  Â  display: flex; justify-content: space-between; padding: 5px 10px;
Â  Â  border: 1px solid #999; margin-bottom: 3px; font-weight: bold; font-size: 1.1em;
}
.red-bg { background: #f8d7da; color: #721c24; }
.white-bg { background: #fff; }
.blue-light-bg { background: #e3f2fd; color: #15609e; }
.text-green { color: #28a745; } .text-red { color: #c0392b; } .text-blue { color: #15609e; }

/* Tableau Paiements Widget */
.dashboard-payments-modern { border: 1px solid #999; }
.modern-payment-table th { background-color: #333; color: #fff; padding: 4px 8px; }
.modern-payment-table td { padding: 4px 8px; border-bottom: 1px solid #ccc; }
.modern-total-row { background-color: #eee; font-weight: bold; }

/* =================================== */
/* MODAL & PHOTOS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â */
/* =================================== */
.modal-backdrop { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
.modal-content { background: #fff; border-radius: 4px; padding: 15px; width: 98%; max-width: 500px; max-height: 98vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.modal-close { position: absolute; top: 5px; right: 10px; font-size: 20px; cursor: pointer; }

#apercu-photos, #photos-recues-apercu { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
#apercu-photos img, #photos-recues-apercu img { width: 40px; height: 40px; object-fit: cover; border: 1px solid #ccc; cursor: pointer; }

/* COULEURS MOIS */
.row-month-0 { background-color: #e1f5fe; } .row-month-1 { background-color: #f3e5f5; } .row-month-2 { background-color: #e8f5e9; }
.row-month-3 { background-color: #fff3e0; } .row-month-4 { background-color: #fce4ec; } .row-month-5 { background-color: #fffde7; }
.row-month-6 { background-color: #e0f2f1; } .row-month-7 { background-color: #ffebee; } .row-month-8 { background-color: #ede7f6; }
.row-month-9 { background-color: #e0f7fa; } .row-month-10 { background-color: #f1f8e9; } .row-month-11 { background-color: #eceff1; }

/* AUTOCOMPLETE */
.autocomplete-container { position: relative; }
.autocomplete-items { display: none; position: absolute; border: 1px solid #999; background: #fff; z-index: 100; top: 100%; left: 0; right: 0; max-height: 150px; overflow-y: auto; }
.autocomplete-items div { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; }
.autocomplete-items div:hover { background: #e9e9e9; }

@media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } header { flex-direction: column; height: auto; } }
/* ======================================================= */
/* MISE EN PAGE ESTHÃ‰TIQUE (GRILLE) POUR PC/TABLETTE Â  Â  Â  */
/* ======================================================= */

@media (min-width: 768px) {
Â  Â  /* Cible uniquement les formulaires dans l'onglet Envoi */
Â  Â  #form-envoi-commun, 
Â  Â  #form-ajout-client {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: 1fr 1fr; /* CrÃ©e 2 colonnes Ã©gales */
Â  Â  Â  Â  gap: 15px 25px; /* Espace vertical (15px) et horizontal (25px) */
Â  Â  Â  Â  align-items: end; /* Aligne les champs vers le bas */
Â  Â  }

Â  Â  /* Ã‰lÃ©ments qui doivent rester sur toute la largeur (titres, boutons, etc.) */
Â  Â  #form-envoi-commun h3,
Â  Â  #form-ajout-client h3,
Â  Â  #form-envoi-commun p,
Â  Â  #form-ajout-client p,
Â  Â  #form-ajout-client hr,
Â  Â  #form-ajout-client button {
Â  Â  Â  Â  grid-column: 1 / -1; /* Prend toute la largeur de la grille */
Â  Â  }

Â  Â  /* Cas particulier : Le champ Description et Photos sont souvent longs */
Â  Â  /* On peut choisir de les mettre en pleine largeur si on veut */
Â  Â  /* Exemple pour les photos : */
Â  Â  #form-ajout-client .form-group:has(input[type="file"]) {
Â  Â  Â  Â  grid-column: 1 / -1;
Â  Â  }
}
/* =================================== */
/* LOGIN & MODIFS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â */
/* =================================== */
#login-overlay {
Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background: linear-gradient(135deg, #15609e 0%, #2c3e50 100%);
Â  Â  display: flex; align-items: center; justify-content: center; z-index: 9999;
}
.login-box {
Â  Â  background: white; padding: 40px; border-radius: 8px;
Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 300px;
}
.login-logo { width: 80px; margin-bottom: 20px; }
#user-display { font-weight: bold; color: #15609e; }
/* Couleur pour l'info de modification */
.modif-info { font-size: 0.8em; color: #e67e22; font-style: italic; }

/* --- CORRECTION HEADER & DECONNEXION --- */
.header-info {
Â  Â  font-size: 0.9em;
Â  Â  color: #555;
Â  Â  display: flex; Â  Â  Â  Â  Â  /* IMPORTANT: Pour aligner le texte et le bouton */
Â  Â  align-items: center; Â  Â  /* Centrage vertical */
Â  Â  gap: 15px; Â  Â  Â  Â  Â  Â  Â  /* Espace entre le nom et le bouton */
}

/* S'assurer que le bouton est bien visible */
.header-info button {
Â  Â  display: inline-block !important;
Â  Â  visibility: visible !important;
Â  Â  opacity: 1 !important;
Â  Â  background-color: #dc3545; /* Rouge pour bien le voir */
Â  Â  color: white;
}

Dans envoi Ã  la liste d'attente le libÃ©llÃ© doit contenir Nom ExpÃ©diteur, Nom destinataire, NumÃ©ro Destinataire, QuantitÃ©, Poids/ Volume, Prix et Action (contient Supprimer et modifier).

Tu peux abrÃ©ger les noms.

Dans Historique & Modif donne moi la possibilitÃ© de tÃ©lÃ©charger en pdf ou execl.
Pdf et excel doivent afficher la rÃ©fÃ©rence, la date, le nom et prÃ©nom du destinataire, tÃ©lÃ©phone du destinataire, description, le type, quantitÃ©, poids ou volume, statut

Je dois pouvoir tÃ©lÃ©charger par goupe d'envoi

Dans Historique & Modif, RÃ©ception (Abidjan) et ComptabilitÃ© Ajoute total CBM ou volume

Donne moi juste les lignes de codes que je dois modifier ou ajouter.

  
